<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load compress static %}
    {% compress css %}
        <link rel="stylesheet" type="text/x-scss" href="{% static 'core/homepage/home-header-style.scss' %}">
        <link rel="stylesheet" type="text/x-scss" href="{% static 'services/manage-sections-styles.scss' %}">
        <link rel="stylesheet" type="text/x-scss" href="{% static 'core/homepage/footer-styles.scss' %}">
    {% endcompress %}
    <title>Manage Sections</title>
</head>
<body>
{% include 'template-components/header-comp.html' with user=request.user %}

<main id="manage-sections-container">
    <h2>Manage Service Sections for {{ service.title }}</h2>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ formset.management_form }}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ formset.management_form }}

            <div id="sections-formset">
                {% for form in formset %}
                    <div class="section-form" data-section-type="{{ form.section_type.value|default:'text_image' }}">
                        {{ form.id }}
                        <div class="form-header">
                            <h3>Section #{{ forloop.counter }}</h3>
                            {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                        </div>

                        <div class="section-type-control">
                            {{ form.section_type.label_tag }}
                            {{ form.section_type }}
                        </div>

                        {{ form.order.as_hidden }}

                        <div class="form-fields">
                            <div class="field-title">
                                {{ form.title.label_tag }}
                                {{ form.title }}
                            </div>

                            <div class="field-content" data-depends-on="content">
                                {{ form.content.label_tag }}
                                {{ form.content }}
                            </div>

                            <div class="field-list-items" data-depends-on="list_items">
                                {{ form.list_items.label_tag }}
                                {{ form.list_items }}
                            </div>

                            <div class="field-image" data-depends-on="image">
                                {{ form.image.label_tag }}
                                {{ form.image }}
                                {% if form.instance.image %}
                                    <img src="{{ form.instance.image.url }}" alt="Current image" width="100"
                                         class="current-image">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button" id="add-more">Add Another Section</button>
            <button type="submit">Save All Sections</button>
        </form>

        <a href="{% url 'extended_service_display' service.id %}" class="cancel-btn">Cancel</a>
    </form>
</main>

{% include 'template-components/footer.html' %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function updateFormFieldsVisibility(formDiv) {
            const sectionType = formDiv.dataset.sectionType;
            const fields = formDiv.querySelectorAll('.form-fields > [data-depends-on]');

            fields.forEach(field => {
                field.style.display = 'none';
            });

            switch (sectionType) {
                case 'text_image':
                    formDiv.querySelector('.field-content').style.display = 'block';
                    formDiv.querySelector('.field-image').style.display = 'block';
                    break;
                case 'list':
                    formDiv.querySelector('.field-list-items').style.display = 'block';
                    break;
                case 'text_only':
                    formDiv.querySelector('.field-content').style.display = 'block';
                    break;
                case 'image_only':
                    formDiv.querySelector('.field-image').style.display = 'block';
                    break;
            }

            const listTextarea = formDiv.querySelector('[data-list-input]');
            if (listTextarea) {
                listTextarea.style.display = sectionType === 'list' ? 'block' : 'none';
            }
        }

        document.querySelectorAll('[name$="-section_type"]').forEach(select => {
            select.addEventListener('change', function () {
                const formDiv = this.closest('.section-form');
                formDiv.dataset.sectionType = this.value;
                updateFormFieldsVisibility(formDiv);
            });
        });

        document.querySelectorAll('.section-form').forEach(updateFormFieldsVisibility);
    });

    document.getElementById('add-more').addEventListener('click', function () {
        console.log('Add new section functionality would go here');
    });
</script>
</body>
</html>