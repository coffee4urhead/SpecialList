{% extends "admin-base.html" %}
{% block title %}Admin Dashboard - Home{% endblock %}

{% block content %}
    <article class="admin-content-container">
        <h2>Blacklist Reports Overview</h2>

        <div class="admin-report-stats-grid">
            <div class="report-card" data-popup-target="reported-users">
                <h3>Reported Users</h3>
                <p>{{ reported_users_count }}</p>
            </div>
            <div class="report-card" data-popup-target="reported-comments">
                <h3>Reported Comments</h3>
                <p>{{ reported_comments_count }}</p>
            </div>
            <div class="report-card" data-popup-target="reported-reviews">
                <h3>Reported Reviews</h3>
                <p>{{ reported_reviews_count }}</p>
            </div>
            <div class="report-card" data-popup-target="reported-services">
                <h3>Reported Services</h3>
                <p>{{ reported_services_count }}</p>
            </div>
        </div>
        <section class="disputes-section">
            <h3>Disputes</h3>
            <table class="disputes-table">
                <thead>
                <tr>
                    <th>Reported</th>
                    <th>Reason</th>
                    <th>Date</th>
                    <th>Reporter</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for dispute in page_obj %}
                    <tr>
                        <td>
                            {% if dispute.content_type == user_ct %}
                                User: {{ dispute.content_object.get_full_name|default:dispute.content_object.username }}
                            {% elif dispute.content_type == service_ct %}
                                Service: {{ dispute.content_object.title }}
                            {% elif dispute.content_type == review_ct %}
                                Review: {{ dispute.content_object.title|truncatechars:20 }}
                            {% elif dispute.content_type == comment_ct %}
                                Comment: {{ dispute.content_object.text|truncatechars:20 }}
                            {% else %}
                                {{ dispute.content_type.model }} #{{ dispute.object_id }}
                            {% endif %}
                        </td>
                        <td>{{ dispute.get_reason_display }}</td>
                        <td>{{ dispute.created_at|date:"M jS, Y" }}</td>
                        <td>{{ dispute.reporter.get_full_name|default:dispute.reporter.username }}</td>
                        <td>
                            <span class="status-badge status-{{ dispute.status }}">
                                {{ dispute.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <button class="btn-view" onclick="viewDispute({{ dispute.id }})">See admin</button>
                            <button class="btn-view"
                                    onclick="window.open('{{ dispute.get_content_url }}', '_blank')">
                                See in website
                            </button>
                            {% if dispute.status == 'pending' %}
                                <button class="btn-approve" data-action="resolve-dispute"
                                        data-dispute-id="{{ dispute.id }}" data-action-type="approve">
                                    Approve
                                </button>
                                <button class="btn-reject" data-action="resolve-dispute"
                                        data-dispute-id="{{ dispute.id }}" data-action-type="reject">Reject
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="empty-message">No pending disputes found.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="pagination">
                <ul class="pagination-list">
                    {% if page_obj.has_previous %}
                        <li><a href="?page=1" class="pagination-link">First</a></li>
                        <li><a href="?page={{ page_obj.previous_page_number }}" class="pagination-link">Previous</a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li><a href="?page={{ num }}" class="pagination-link is-current">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li><a href="?page={{ num }}" class="pagination-link">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li><a href="?page={{ page_obj.next_page_number }}" class="pagination-link">Next</a></li>
                        <li><a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-link">Last</a></li>
                    {% endif %}
                </ul>
            </div>
        </section>
    </article>
    <div class="dashboard-layout">
        <main id="main-web-container">
            <section class="ban-warnings blacklist-section">
                <h4>Ban Warnings</h4>
                {% for profile in warned_profiles %}
                    <div class="user-card">
                        <p><strong>{{ profile.user.get_full_name }}</strong> ({{ profile.user.email }})</p>
                        <p>Warnings: {{ profile.warning_count }}</p>
                        <p>Last Warning: {{ profile.last_warning|date:"Y-m-d H:i" }}</p>
                        <button onclick="issueWarning({{ profile.user.id }})">Send Warning</button>
                    </div>
                {% empty %}
                    <p class="empty-message">No users with warnings.</p>
                {% endfor %}
            </section>

            <section class="banned-accounts blacklist-section">
                <h4>Banned Accounts</h4>
                {% for profile in banned_profiles %}
                    <div class="user-card">
                        <p><strong>{{ profile.user.get_full_name }}</strong> ({{ profile.user.email }})</p>
                        <p>Banned on: {{ profile.banned_at|date:"Y-m-d H:i" }}</p>
                        <p>Reason: {{ profile.ban_reason }}</p>
                        <button data-action="unban-user" data-user-id="{{ profile.user.id }}">Unban</button>
                    </div>
                {% empty %}
                    <p class="empty-message">No banned accounts found.</p>
                {% endfor %}
            </section>
        </main>
    </div>

    <script type="module">
        import getCookie from "../../../static/js-scripts/utils.js";

        function issueWarning(userId) {
            fetch(`/admin/issue-warning/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({user_id: userId})
            }).then(() => window.location.reload());
        }

        function unbanUser(userId) {
            fetch('/dashboard/unban-user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({user_id: userId})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('An error occurred while unbanning the user.');
                });
        }

        function viewDispute(disputeId) {
            window.location.href = `/admin/core/blacklistitem/${disputeId}/change/`;
        }

        function resolveDispute(disputeId, action) {
            fetch(`/dashboard/resolve-dispute/${disputeId}/${action}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({})
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error resolving dispute. Please try again.');
                });
        }

        document.addEventListener('click', function (e) {
            const resolveBtn = e.target.closest('[data-action="resolve-dispute"]');
            if (resolveBtn) {
                const disputeId = resolveBtn.dataset.disputeId;
                const action = resolveBtn.dataset.actionType;
                resolveDispute(disputeId, action);
            }
        });

    </script>
{% endblock %}
